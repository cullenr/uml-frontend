<!DOCTYPE html>
<html>
<head>
    <title>UML Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.css" media="screen">
    <style type="text/css">
        #canvas-container {
            background: #F0F;
            width: 100%;
            height: 100%;

            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../../assets/js/html5shiv.js"></script>
      <script src="../../assets/js/respond.min.js"></script>
      <![endif]-->
  </head>
  <body>
    <button type="button" class="btn btn-primary" onclick="lexer.uml.classView.createView()" >Go!</button>
    <div id="canvas-container">
        <svg id="svg-canvas" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
        <style>
            .fo {

            }

            .class-view-container {
                text-align: center;    
            }

            .class-view {
                background: #FFFFBF;
                border: 3px;
                border-style: solid;
                border-color: #ABABAB;
                cursor: move;
            }     

            .class-view tbody{
                border-top: 3px;
                border-style: solid;
                border-color: #ABABAB;
            }

            .property {
                text-align: left;
                cursor: text;
            }

            .tool {
                color: #FFFFBF;
                cursor: pointer;
            }

            .class-view-container:hover .tool{
                color: #000000;
            }

            .add-link-tool {
                visibility: hidden;
                cursor: pointer;
            }
            
            .class-view-container:hover .add-link-tool{
                visibility: visible;
            }

            .drag {
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        </style>
        <script xmlns="http://www.w3.org/2000/svg" type="text/ecmascript"><![CDATA[
            "use strict";
            
            var lexer = lexer || {};
            lexer.svg = lexer.svg || {};
            lexer.svg.styling = lexer.svg.styling || {};

            (function(scope, $, undefined){

                scope.addClass = function(element, cssClass) {
                    var attr = element.getAttribute("class");
                    if(attr.indexOf(cssClass) === -1){
                        element.setAttribute("class", attr += attr.slice(-1) === " " ? cssClass : " " + cssClass);
                    }
                };

                scope.removeClass = function(element, cssClass) {
                    var attr = element.getAttribute("class");
                    var newAttr = attr.replace(cssClass, "");
                    element.setAttribute("class", newAttr);
                };
            })(lexer.svg.styling, $, undefined);

            lexer.svg.drag = lexer.svg.drag || {};
            (function(scope, $, undefined){
                var selectedElement = 0;
                var offsetX = 0;
                var offsetY = 0;
                var svgElement = document.getElementById("svg-canvas");

                var mouseMoveListener = function(e) {
                    var x = (e.pageX - offsetX) / svgElement.currentScale;
                    var y = (e.pageY - offsetY) / svgElement.currentScale;
                    selectedElement.setAttributeNS(null, "transform", "translate(" + x  + ", " + y + ")");
                };
                
                var mouseUpLitener = function(e) {
                    document.removeEventListener("mousemove", mouseMoveListener);
                    document.removeEventListener("mouseup", mouseUpLitener);

                    lexer.svg.styling.removeClass(selectedElement, "drag");
                };

                scope.startMoveElement = function(e) {
                    selectedElement = $(e.target).closest(".fo")[0];
                    if(typeof selectedElement == 'undefined'){
                        return;
                    }
                    document.addEventListener("mousemove", mouseMoveListener);
                    document.addEventListener("mouseup", mouseUpLitener);
                    offsetX = $("#svg-canvas").position().left - ($(selectedElement).position().left - e.pageX);
                    offsetY = $("#svg-canvas").position().top - ($(selectedElement).position().top - e.pageY);

                    lexer.svg.styling.addClass(selectedElement, "drag");
                };
            })(lexer.svg.drag, $, undefined);
        ]]></script>
        </svg>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        window.lexer = window.lexer || {};
        window.lexer.uml = window.lexer.uml || {};

        (function(scope, $, undefined){
            var defaultClassView = '<foreignObject class="fo" width="100%" height="100%" transform="matrix(1 0 0 1 0 0)" onmousedown="lexer.svg.drag.startMoveElement(evt)">\
                    <body xmlns="http://www.w3.org/1999/xhtml">\
    <table class="class-view-container">\
        <tbody>\
            <tr>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
            </tr>\
            <tr>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
                <td>\
                    <table class="class-view">\
                        <thead>\
                            <tr>\
                                <td class="property" onmouseup="lexer.uml.classView.updateProperty(event)" contenteditable="true">Class</td>\
                                <td></td>\
                                <td></td>\
                                <td class="tool" onmouseup="lexer.uml.classView.deleteView(event)" title="Delete class">&#x2716;</td>\
                            </tr>\
                        </thead>\
                        <tbody>\
                            <tr>\
                                <td></td>\
                                <td></td>\
                                <td></td>\
                                <td class="tool" onmouseup="lexer.uml.classView.createProperty(event)" title="Add property">&#x271a;</td>\
                            </tr>\
                        </tbody>\
                        <tbody>\
                            <tr>\
                                <td></td>\
                                <td></td>\
                                <td></td>\
                                <td class="tool" onmouseup="lexer.uml.classView.createProperty(event)" title="Add property">&#x271a;</td>\
                            </tr>\
                        </tbody>\
                    </table>\
                </td>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
            </tr>\
            <tr>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
                <td class="add-link-tool" title="Add link">&#x271a;</td>\
            </tr>\
        </tbody>\
    </table>\
    </body>\
    </foreignObject>\
            ';
            var defaultPropertyView = '<tr class="property">\
                                <td onmouseup="lexer.uml.classView.updateProperty(event)" contenteditable="true">...</td>\
                                <td class="tool" onmouseup="lexer.uml.classView.movePropertyUp(event)" title="Move property up">&#x25b2;</td>\
                                <td class="tool" onmouseup="lexer.uml.classView.movePropertyDown(event)" title="Move property down">&#x25bc;</td>\
                                <td class="tool" onmouseup="lexer.uml.classView.deleteProperty(event)" title="Delete property">&#x2716;</td>\
                            </tr>';

            scope.createView = function(){
                $("#svg-canvas").append(defaultClassView);
                $("#canvas-container").html($("#canvas-container").html());
            };
            
            scope.deleteView = function(evt){
                var element = $(evt.target).closest(".fo").first();
                if(typeof element !== "undefined") {
                    element.remove();
                }
            };

            scope.deleteProperty = function(evt){
                $(evt.target).parent().remove();
            };

            scope.createProperty = function(evt){
                var parent = $(evt.target).parent();
                console.log(parent);
                parent.before(defaultPropertyView);
            };

            scope.updateProperty = function(evt){
                
            };

            scope.movePropertyUp = function(evt){
                var parent = $(evt.target).parent();
                if(parent.prev().is(".property")) {
                    parent.insertBefore(parent.prev());     
                }
            };

            scope.movePropertyDown = function(evt){
                var parent = $(evt.target).parent();
                if(parent.next().is(".property")) {
                    parent.insertAfter(parent.next());     
                }
            };

        })(window.lexer.uml.classView = window.lexer.uml.classView || {}, $, undefined);
    </script>                                
    <div class="fo">
    <table class="class-view-container">
        <tbody>
            <tr>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
            </tr>
            <tr>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
                <td>
                    <table class="class-view">
                        <thead>
                            <tr>
                                <td class="property" onmouseup="lexer.uml.classView.updateProperty(event)" contenteditable="true">Class</td>
                                <td></td>
                                <td></td>
                                <td class="tool" onmouseup="lexer.uml.classView.deleteView(event)" title="Delete class">&#x2716;</td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td class="tool" onmouseup="lexer.uml.classView.createProperty(event)" title="Add property">&#x271a;</td>
                            </tr>
                        </tbody>
                        <tbody>
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td class="tool" onmouseup="lexer.uml.classView.createProperty(event)" title="Add property">&#x271a;</td>
                            </tr>
                        </tbody>
                    </table>
                </td>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
            </tr>
            <tr>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
                <td class="add-link-tool" title="Add link">&#x271a;</td>
            </tr>
        </tbody>
    </table>
        
    </div>
  </body>
</html>

<!-- Fictitious Quotes

I aint writing no UML foo'
- Mr T

-->
