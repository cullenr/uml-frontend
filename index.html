<!DOCTYPE html>
<html>
<head>
    <title>UML Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.css" media="screen">
    <style type="text/css">
        #canvas-container {
            background: #F0F;
            width: 1024px;
            height: 1024px;
        }
    </style>
    <script src="js/jquery-2.0.3.min.js"></script>
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../../assets/js/html5shiv.js"></script>
      <script src="../../assets/js/respond.min.js"></script>
      <![endif]-->
  </head>
  <body>
    <button type="button" class="btn btn-primary" onclick="lexer.uml.classView.createView()" >Go!</button>

    <div id="canvas-container">
        <svg id="svg-canvas" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" width="1024px" height="1024px" viewBox="0 0 1024 1024" currentScale="1.0">
        <style>
            .fo {

            }

            .class-view-container {
                text-align: center;
                position: static;   
            }

            .class-view {
                background: #FFFFBF;
                border: 3px;
                border-style: solid;
                border-color: #ABABAB;
                cursor: move;
            }     

            .class-view tbody{
                border-top: 3px;
                border-style: solid;
                border-color: #ABABAB;

            }

            .property {
                text-align: left;
                cursor: text;
            }

            .tool {
                color: #FFFFBF;
                cursor: pointer;
            }

            .add-link-tool {
                visibility: hidden;
                cursor: pointer;
                height: 33%;
                vertical-align: middle;
            }

            .v-link-tool-container {
                height: 80px;
                line-height: 80px;
            }

            .class-view-container:hover .tool{
                color: #000000;
            }
            
            .class-view-container:hover .add-link-tool{
                visibility: visible;
            }

            .drag {
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            .v-centre {
                display: table-cell; vertical-align: middle 
            }
        </style>
        <defs>
            <marker id="Triangle"
                    viewBox="0 0 10 10" 
                    refX="1" refY="5"
                    markerWidth="6" 
                    markerHeight="6"
                    orient="auto">
                <path d="M 0 0 L 10 5 L 0 10 z" />
            </marker>
        </defs>
        <script xmlns="http://www.w3.org/2000/svg" type="text/ecmascript"><![CDATA[
            "use strict";
            
            var lexer = lexer || {};
            lexer.svg = lexer.svg || {};
            lexer.svg.styling = lexer.svg.styling || {};

            (function(scope, $, undefined){
                scope.addClass = function(element, cssClass) {
                    var attr = element.getAttribute("class");
                    if(attr.indexOf(cssClass) === -1){
                        element.setAttribute("class", attr += attr.slice(-1) === " " ? cssClass : " " + cssClass);
                    }
                };

                scope.removeClass = function(element, cssClass) {
                    var attr = element.getAttribute("class");
                    var newAttr = attr.replace(cssClass, "");
                    element.setAttribute("class", newAttr);
                };
            })(lexer.svg.styling, $, undefined);

            lexer.svg.drag = lexer.svg.drag || {};
            (function(scope, $, undefined){
                var selectedElement = 0;
                var offsetX = 0;
                var offsetY = 0;
                var svgElement = document.getElementById("svg-canvas");

                var mouseMoveListener = function(e) {
                    var x = (e.pageX - offsetX) / svgElement.currentScale;
                    var y = (e.pageY - offsetY) / svgElement.currentScale;
                    //selectedElement.setAttributeNS(null, "transform", "translate(" + x  + ", " + y + ")");

                    selectedElement.setAttribute("x", x);
                    selectedElement.setAttribute("y", y);

                    return false;
                };
                
                var mouseUpLitener = function(e) {
                    document.removeEventListener("mousemove", mouseMoveListener);
                    document.removeEventListener("mouseup", mouseUpLitener);
 
                    lexer.svg.styling.removeClass(selectedElement, "drag");                        

                    return true;
                };

                scope.startMoveElement = function(e) {
                    selectedElement = $(e.target).closest(".fo")[0];
                    if(typeof selectedElement == 'undefined'){
                        return;
                    }
                    document.addEventListener("mousemove", mouseMoveListener);
                    document.addEventListener("mouseup", mouseUpLitener);
                    offsetX = $("#svg-canvas").position().left - ($(selectedElement).position().left - e.pageX);
                    offsetY = $("#svg-canvas").position().top - ($(selectedElement).position().top - e.pageY);

                    lexer.svg.styling.addClass(selectedElement, "drag");

                    return true;
                };
            })(lexer.svg.drag, $, undefined);
        ]]></script>
        </svg>
    </div>
    <script type="text/javascript">
        window.lexer = window.lexer || {};
        window.lexer.uml = window.lexer.uml || {};

        (function(scope, $, undefined){
            var defaultClassView = '<foreignObject xmlns="http://www.w3.org/2000/svg" class="fo" width="1024px" height="1024px" >\
            <html xmlns="http://www.w3.org/1999/xhtml">\
                <body>\
                    <table xmlns="http://www.w3.org/1999/xhtml" class="class-view-container" >\
                        <tbody>\
                            <tr>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                            </tr>\
                            <tr>\
                                <td class="v-link-tool-container" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">\
                                    <div></div>\
                                    <div class="add-link-tool" ><div class="v-centre">&#x271a;</div></div>\
                                    <div class="add-link-tool" ><div class="v-centre">&#x271a;</div></div>\
                                    <div class="add-link-tool" ><div class="v-centre">&#x271a;</div></div>\
                                </td>\
                                <td colspan="3">\
                                    <table class="class-view"  onmousedown="lexer.svg.drag.startMoveElement(event)">\
                                        <thead>\
                                            <tr>\
                                                <td class="property" onmouseup="lexer.uml.classView.updateProperty(event)" contenteditable="true">Class</td>\
                                                <td></td>\
                                                <td></td>\
                                                <td class="tool" onmouseup="lexer.uml.classView.deleteView(event)" title="Delete class">&#x2716;</td>\
                                            </tr>\
                                        </thead>\
                                        <tbody>\
                                            <tr>\
                                                <td></td>\
                                                <td></td>\
                                                <td></td>\
                                                <td class="tool" onmouseup="lexer.uml.classView.createProperty(event)" title="Add property">&#x271a;</td>\
                                            </tr>\
                                        </tbody>\
                                        <tbody>\
                                            <tr>\
                                                <td></td>\
                                                <td></td>\
                                                <td></td>\
                                                <td class="tool" onmouseup="lexer.uml.classView.createProperty(event)" title="Add property">&#x271a;</td>\
                                            </tr>\
                                        </tbody>\
                                    </table>\
                                </td>\
                                <td class="v-link-tool-container" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">\
                                    <div class="add-link-tool" >&#x271a;</div>\
                                    <div class="add-link-tool" >&#x271a;</div>\
                                    <div class="add-link-tool" >&#x271a;</div>\
                                </td>\
                            </tr>\
                            <tr>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                                <td class="add-link-tool" onmouseup="lexer.uml.relation.onRelationPressed(event)" title="Add relation">&#x271a;</td>\
                            </tr>\
                        </tbody>\
                    </table>\
                </body>\
            </html>\
        </foreignObject>';
            var defaultPropertyView = '<tr class="property">\
                                <td contenteditable="true">...</td>\
                                <td class="tool" onmouseup="lexer.uml.classView.movePropertyUp(event)" title="Move property up">&#x25b2;</td>\
                                <td class="tool" onmouseup="lexer.uml.classView.movePropertyDown(event)" title="Move property down">&#x25bc;</td>\
                                <td class="tool" onmouseup="lexer.uml.classView.deleteProperty(event)" title="Delete property">&#x2716;</td>\
                            </tr>';

            scope.createView = function(){
                $("#svg-canvas").append(defaultClassView);
                $("#canvas-container").html($("#canvas-container").html());
            };
            
            scope.deleteView = function(e){
                var element = $(e.target).closest(".fo").first();
                if(typeof element !== "undefined") {
                    element.remove();
                }
            };

            scope.deleteProperty = function(e){
                $(e.target).parent().remove();
            };

            scope.createProperty = function(e){
                var parent = $(e.target).parent();
                parent.before(defaultPropertyView);

                var container = $(parent).closest(".fo").first();
                layoutRelationshipButtons(container);
            };

            scope.movePropertyUp = function(e){
                var parent = $(e.target).parent();
                if(parent.prev().is(".property")) {
                    parent.insertBefore(parent.prev());     
                }
            };

            scope.movePropertyDown = function(e){
                var parent = $(e.target).parent();
                if(parent.next().is(".property")) {
                    parent.insertAfter(parent.next());     
                }
            };

            function layoutRelationshipButtons(classContainer) {

            }

        })(window.lexer.uml.classView = window.lexer.uml.classView || {}, $, undefined);

        (function(scope, $, undefined){
            var defaultRelation = '<g>\
                    <circle class="relation-start" r="5" />\
                    <polyline fill="none" stroke="black" marker-end="url(#Triangle)" points="0,0 0,0"/>\
                </g>';
            var startedRelation = 0;

            scope.onRelationPressed = function(e){
                var selectedElement = e.target;
                var relation = $(defaultRelation);
                var offsetX = $("#svg-canvas").position().left;
                var offsetY = $("#svg-canvas").position().top;
                relation.children(".relation-start").attr("cx", e.pageX - offsetX);
                relation.children(".relation-start").attr("cy", e.pageY - offsetY);
                $("#svg-canvas").append(relation);
                $("#canvas-container").html($("#canvas-container").html());
            };

            function finisheRelation(e){
                console.log(e);

                startedRelation = 0;
            };

            function startRelation(e){
                console.log(e);

                startedRelation = 1;
            };

        })(window.lexer.uml.relation = window.lexer.uml.relation || {}, $, undefined);

    </script>                                
  </body>
</html>

<!-- Fictitious Quotes

I aint writing no UML foo'
- Mr T

-->
